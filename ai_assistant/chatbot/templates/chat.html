<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% load static %}
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <title>MaintenanceMateAI Assistant</title>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'parihar': {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'bounce-gentle': 'bounce 2s infinite',
                        'gradient': 'gradient 8s ease infinite',
                    },
                    keyframes: {
                        gradient: {
                            '0%, 100%': { 'background-position': '0% 50%' },
                            '50%': { 'background-position': '100% 50%' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .w-10 {
    width: 7.5rem !important;
}
        .gradient-bg {
            background: linear-gradient(-45deg, #667eea, #764ba2, #f093fb, #f5576c);
            background-size: 400% 400%;
            animation: gradient 15s ease infinite;
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.25);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .chat-scroll {
            scrollbar-width: thin;
            scrollbar-color: #cbd5e1 transparent;
        }

        .chat-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .chat-scroll::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-scroll::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        .chat-scroll::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        @keyframes typing {
            0%, 20% { transform: scale(1); }
            50% { transform: scale(1.2); }
            80%, 100% { transform: scale(1); }
        }

        .typing-dot {
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        .message-slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo-glow {
            filter: drop-shadow(0 0 20px rgba(14, 165, 233, 0.5));
        }
        .imgg{
            width:100px;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Mobile Menu Button -->
        <button id="mobile-menu-button" class="lg:hidden fixed top-4 left-4 z-50 p-2 bg-white dark:bg-gray-800 rounded-lg shadow-lg text-gray-600 dark:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">
            <i class="fas fa-bars text-xl"></i>
        </button>

        <!-- Sidebar -->
        
<!-- Sidebar -->
<div id="sidebar" class="fixed inset-y-0 left-0 z-40 w-80 bg-white dark:bg-gray-800 shadow-xl transform -translate-x-full lg:translate-x-0 lg:static lg:inset-0 transition-transform duration-300 ease-in-out flex flex-col">
    <!-- Sidebar Header -->
    <div class="p-6 border-b border-gray-200 dark:border-gray-700">
        <div class="flex items-center space-x-3 mb-4">
            <!-- Parihar Logo -->
            <div class="relative">
                <img src="{% static 'images/logot.png' %}" alt="Prahari AI Logo" class="imgg" class="w-12 h-12 rounded-xl logo-glow object-contain">
                
            </div>
            {% comment %} <div>
                <h1 class="text-xl font-bold text-gray-800 dark:text-white">Prahari AI</h1>
                <p class="text-sm text-gray-500 dark:text-gray-400">Your Intelligent Assistant</p>
            </div> {% endcomment %}
        </div>
        
        <button id="new-chat" class="w-full bg-gradient-to-r from-parihar-500 to-parihar-600 hover:from-parihar-600 hover:to-parihar-700 text-white font-medium py-3 px-4 rounded-xl transition-all duration-200 transform hover:scale-105 shadow-lg">
            <i class="fas fa-plus mr-2"></i>
            New Conversation
        </button>
    </div>

    <!-- Chat List -->
    <div class="flex-1 overflow-y-auto chat-scroll p-4">
        <div class="space-y-2">
            {% for session in chat_sessions %}
                <div class="chat-item group relative bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-xl p-4 cursor-pointer transition-all duration-200 {% if session.id == active_session_id %}bg-gradient-to-r from-parihar-50 to-parihar-100 dark:from-parihar-900 dark:to-parihar-800 border-2 border-parihar-200 dark:border-parihar-700{% endif %}" 
                     data-session-id="{{ session.id }}">
                    
                    <div class="flex items-start justify-between">
                        <div class="flex-1 min-w-0">
                            <h3 class="font-medium text-gray-800 dark:text-white truncate text-sm mb-1">
                                {{ session.title|default:"New Chat" }}
                            </h3>
                            <div class="flex items-center text-xs text-gray-500 dark:text-gray-400">
                                <i class="fas fa-clock mr-1"></i>
                                <span>{{ session.updated_at|date:"M d, Y H:i" }}</span>
                            </div>
                        </div>
                        
                        <button class="delete-chat-button opacity-0 group-hover:opacity-100 p-2 text-gray-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded-lg transition-all duration-200" 
                                data-session-id="{{ session.id }}" 
                                title="Delete chat">
                            <i class="fas fa-trash-alt text-sm"></i>
                        </button>
                    </div>
                    
                    <!-- Active indicator -->
                    {% if session.id == active_session_id %}
                        <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-1 h-8 bg-parihar-500 rounded-r-full"></div>
                    {% endif %}
                </div>
            {% endfor %}
            
            {% if not chat_sessions %}
                <div class="text-center py-8">
                    <div class="w-16 h-16 mx-auto mb-4 bg-gray-100 dark:bg-gray-700 rounded-full flex items-center justify-center">
                        <i class="fas fa-comments text-2xl text-gray-400"></i>
                    </div>
                    <p class="text-gray-500 dark:text-gray-400 text-sm">No conversations yet</p>
                    <p class="text-gray-400 dark:text-gray-500 text-xs mt-1">Start chatting to see your history</p>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Sidebar Footer -->
    <div class="p-4 border-t border-gray-200 dark:border-gray-700">
        <div class="flex items-center space-x-2 text-xs text-gray-500 dark:text-gray-400">
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
            <span>MaintenanceMateAI is online</span>
        </div>
    </div>
</div>

        <!-- Sidebar Overlay for Mobile -->
        <div id="sidebar-overlay" class="fixed inset-0 bg-black bg-opacity-50 z-30 lg:hidden hidden"></div>

        <!-- Main Chat Area -->
        <div class="flex-1 flex flex-col min-w-0">
            <!-- Chat Header -->
            <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 p-4 lg:p-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        {% comment %} <img src="{% static 'images/logot.png' %}" alt="MaintenanceMateAI Logo" class="w-10 h-10 rounded-xl logo-glow object-contain"> {% endcomment %}
                         <div>
                            <h2 class="text-lg font-semibold text-gray-800 dark:text-white">MaintenanceMateAI</h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Ready to help you with anything</p>
                        </div>
                    </div>
                    
                    <div class="flex items-center space-x-2">
                        <button id="speech-toggle-button" class="p-2 text-gray-400 hover:text-parihar-500 hover:bg-parihar-50 dark:hover:bg-parihar-900/20 rounded-lg transition-colors" title="Toggle voice output">
                            <i class="fas fa-volume-up"></i>
                        </button>
                        <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
                    </div>
                </div>
            </div>

            <!-- Messages Container -->
            <div id="messages-container" class="flex-1 overflow-y-auto chat-scroll px-4 lg:px-6 py-4">
                {% if messages %}
                    {% for message in messages %}
                        <div class="message-slide-in mb-6 {% if message.is_user %}flex justify-end{% else %}flex justify-start{% endif %}">
                            <div class="flex items-start space-x-3 max-w-4xl">
                                {% if not message.is_user %}
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-gradient-to-r from-parihar-500 to-parihar-600 rounded-lg flex items-center justify-center">
                                            <span class="text-white font-bold text-sm">P</span>
                                        </div>
                                    </div>
                                {% endif %}
                                
                                <div class="flex flex-col {% if message.is_user %}items-end{% else %}items-start{% endif %}">
                                    <div class="{% if message.is_user %}bg-gradient-to-r from-parihar-500 to-parihar-600 text-white{% else %}bg-white dark:bg-gray-700 text-gray-800 dark:text-white shadow-lg{% endif %} rounded-2xl px-4 py-3 max-w-md lg:max-w-2xl">
                                        {% if message.text %}
                                            <p class="text-sm leading-relaxed">{{ message.text }}</p>
                                        {% endif %}
                                        
                                        {% if message.file_data %}
                                            <div class="mt-3">
                                                {% if message.file_mime_type|slice:":6" == "image/" %}
                                                    <img src="data:{{ message.file_mime_type }};base64,{{ message.file_data }}" 
                                                         alt="Uploaded content" 
                                                         class="rounded-lg max-w-full h-auto shadow-md">
                                                {% elif message.file_mime_type == "application/pdf" %}
                                                    <div class="flex items-center space-x-3 p-3 bg-red-50 dark:bg-red-900/20 rounded-lg border border-red-200 dark:border-red-800">
                                                        <div class="w-10 h-10 bg-red-100 dark:bg-red-900/40 rounded-lg flex items-center justify-center">
                                                            <i class="fas fa-file-pdf text-red-500"></i>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium text-red-800 dark:text-red-200 text-sm">PDF Document</p>
                                                            <p class="text-red-600 dark:text-red-300 text-xs">Successfully uploaded</p>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <div class="flex items-center space-x-3 p-3 bg-gray-50 dark:bg-gray-600 rounded-lg">
                                                        <div class="w-10 h-10 bg-gray-100 dark:bg-gray-700 rounded-lg flex items-center justify-center">
                                                            <i class="fas fa-file text-gray-500"></i>
                                                        </div>
                                                        <div>
                                                            <p class="font-medium text-gray-800 dark:text-gray-200 text-sm">File Attachment</p>
                                                            <p class="text-gray-600 dark:text-gray-400 text-xs">{{ message.file_mime_type }}</p>
                                                        </div>
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <span class="text-xs text-gray-400 mt-1 px-2">
                                        {% if message.is_user %}You{% else %}MaintenanceMateAI{% endif %}
                                    </span>
                                </div>
                                
                                {% if message.is_user %}
                                    <div class="flex-shrink-0">
                                        <div class="w-8 h-8 bg-gray-300 dark:bg-gray-600 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-user text-gray-600 dark:text-gray-300 text-sm"></i>
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <div id="empty-state" class="flex-1 flex items-center justify-center">
                        <div class="text-center max-w-md mx-auto">
                            <div class="relative mb-8">
                                <div class="w-24 h-24 mx-auto bg-gradient-to-r from-parihar-500 to-parihar-600 rounded-3xl flex items-center justify-center logo-glow">
                                    <span class="text-white font-bold text-4xl">M</span>
                                </div>
                                <div class="absolute -top-2 -right-2 w-8 h-8 bg-green-400 rounded-full border-4 border-white dark:border-gray-900 animate-bounce-gentle"></div>
                            </div>
                            
                            <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-2">MaintenanceMate AI</h3>
                            <p class="text-gray-600 dark:text-gray-400 mb-6">Your intelligent assistant is ready to help. Ask me anything or upload a file to get started!</p>
                            
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                                    <i class="fas fa-lightbulb text-parihar-500 mb-2"></i>
                                    <p class="font-medium text-gray-800 dark:text-white">Ask Questions</p>
                                    <p class="text-gray-600 dark:text-gray-400 text-xs">Get answers on any topic</p>
                                </div>
                                <div class="bg-white dark:bg-gray-800 p-4 rounded-xl shadow-sm border border-gray-200 dark:border-gray-700">
                                    <i class="fas fa-file-upload text-parihar-500 mb-2"></i>
                                    <p class="font-medium text-gray-800 dark:text-white">Upload Files</p>
                                    <p class="text-gray-600 dark:text-gray-400 text-xs">Images, PDFs, and more</p>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
                
                <!-- Loading Indicator -->
                <div class="loading-indicator hidden mb-6">
                    <div class="flex justify-start">
                        <div class="flex items-start space-x-3 max-w-4xl">
                            <div class="flex-shrink-0">
                                <div class="w-8 h-8 bg-gradient-to-r from-parihar-500 to-parihar-600 rounded-lg flex items-center justify-center animate-pulse-slow">
                                    <span class="text-white font-bold text-sm">P</span>
                                </div>
                            </div>
                            <div class="bg-white dark:bg-gray-700 rounded-2xl px-4 py-3 shadow-lg">
                                <div class="flex items-center space-x-2">
                                    <span class="text-sm text-gray-600 dark:text-gray-300">MaintenanceMate is thinking</span>
                                    <div class="flex space-x-1">
                                        <div class="w-2 h-2 bg-parihar-500 rounded-full typing-dot"></div>
                                        <div class="w-2 h-2 bg-parihar-500 rounded-full typing-dot"></div>
                                        <div class="w-2 h-2 bg-parihar-500 rounded-full typing-dot"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Input Container -->
            <div class="bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 p-4 lg:p-6">
             <div class="max-w-4xl mx-auto">
                    <form id="chat-form" class="relative">
                        <input type="file" id="file-input" accept="image/*,application/pdf" class="hidden">
                        
                        <div class="flex items-end space-x-3">
                            <!-- Action Buttons -->
                            <div class="flex space-x-2">
                                <button type="button" id="file-button" class="p-3 text-gray-400 hover:text-parihar-500 hover:bg-parihar-50 dark:hover:bg-parihar-900/20 rounded-xl transition-colors" title="Upload file">
                                    <i class="fas fa-paperclip text-lg"></i>
                                </button>
                                
                                <button type="button" id="mic-button" class="p-3 text-gray-400 hover:text-parihar-500 hover:bg-parihar-50 dark:hover:bg-parihar-900/20 rounded-xl transition-colors" title="Voice input">
                                    <i class="fas fa-microphone text-lg"></i>
                                </button>
                                
                                <button type="button" id="qr-button" class="p-3 text-gray-400 hover:text-parihar-500 hover:bg-parihar-50 dark:hover:bg-parihar-900/20 rounded-xl transition-colors" title="Scan QR Code">
                                    <i class="fas fa-qrcode text-lg"></i>
                                </button>
                            </div>
                            
                            <!-- Input Field -->
                            <div class="flex-1 relative">
                                <input type="text" 
                                       id="text-input" 
                                       class="w-full bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-2xl px-6 py-4 pr-14 text-gray-800 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-parihar-500 focus:border-transparent transition-all duration-200" 
                                       placeholder="Message MaintenanceMate AI..." 
                                       autocomplete="off">
                                
                                <button type="submit" 
                                        id="send-button" 
                                        class="absolute right-2 top-1/2 transform -translate-y-1/2 w-10 h-10 bg-gradient-to-r from-parihar-500 to-parihar-600 hover:from-parihar-600 hover:to-parihar-700 disabled:from-gray-400 disabled:to-gray-500 text-white rounded-xl transition-all duration-200 flex items-center justify-center disabled:cursor-not-allowed">
                                    <i class="fas fa-paper-plane text-sm"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Status Indicators -->
                        <div class="flex items-center justify-between mt-3 text-xs text-gray-500 dark:text-gray-400">
                            
                            
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Video (Hidden) -->
    <video id="qr-video" class="hidden" autoplay></video>
    
    <script src="{% static 'js/jsQR.min.js' %}"></script>
    <script>
        // Text-to-Speech function
        function speakText(text, speechEnabled) {
            if (!window.speechSynthesis || !speechEnabled) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 1;
            utterance.pitch = 1;
            window.speechSynthesis.speak(utterance);
        }

        class ChatApp {
            constructor() {
                this.isSending = false;
                this.currentSessionId = {{ active_session_id|default:"null" }};
                this.isRecording = false;
                this.recognition = null;
                this.speechEnabled = true;
                this.initializeElements();
                this.initializeSpeechRecognition();
                this.initializeMobileMenu();
                this.attachEventListeners();
                this.updateButtonStates();
                this.scrollToBottom();
            }

            initializeElements() {
                this.messagesContainer = document.getElementById('messages-container');
                this.emptyState = document.getElementById('empty-state');
                this.chatForm = document.getElementById('chat-form');
                this.textInput = document.getElementById('text-input');
                this.fileInput = document.getElementById('file-input');
                this.fileButton = document.getElementById('file-button');
                this.micButton = document.getElementById('mic-button');
                this.sendButton = document.getElementById('send-button');
                this.newChatButton = document.getElementById('new-chat');
                this.chatItems = document.querySelectorAll('.chat-item');
                this.deleteButtons = document.querySelectorAll('.delete-chat-button');
                this.qrButton = document.getElementById('qr-button');
                this.qrVideo = document.getElementById('qr-video');
                this.speechToggleButton = document.getElementById('speech-toggle-button');
                this.sidebar = document.getElementById('sidebar');
                this.sidebarOverlay = document.getElementById('sidebar-overlay');
                this.mobileMenuButton = document.getElementById('mobile-menu-button');
            }

            initializeMobileMenu() {
                this.mobileMenuButton.addEventListener('click', () => {
                    this.sidebar.classList.toggle('-translate-x-full');
                    this.sidebarOverlay.classList.toggle('hidden');
                });

                this.sidebarOverlay.addEventListener('click', () => {
                    this.sidebar.classList.add('-translate-x-full');
                    this.sidebarOverlay.classList.add('hidden');
                });
            }

            initializeSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = true;
                    this.recognition.lang = 'en-US';

                    this.recognition.onresult = (event) => {
                        let transcript = '';
                        for (let i = 0; i < event.results.length; i++) {
                            const result = event.results[i][0];
                            if (result.isFinal) {
                                transcript = result.transcript;
                                this.textInput.value = transcript;
                                this.updateButtonStates();
                            } else {
                                this.textInput.value = result.transcript;
                            }
                        }
                    };

                    this.recognition.onend = () => {
                        if (this.isRecording) {
                            this.isRecording = false;
                            this.micButton.classList.remove('text-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                            this.micButton.classList.add('text-gray-400', 'hover:text-parihar-500', 'hover:bg-parihar-50', 'dark:hover:bg-parihar-900/20');
                            this.updateButtonStates();
                            if (this.textInput.value.trim()) {
                                this.handleSubmit(new Event('submit'));
                            }
                        }
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.isRecording = false;
                        this.micButton.classList.remove('text-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                        this.micButton.classList.add('text-gray-400', 'hover:text-parihar-500', 'hover:bg-parihar-50', 'dark:hover:bg-parihar-900/20');
                        this.updateButtonStates();
                        alert(`Speech recognition error: ${event.error}. Please try again.`);
                    };
                } else {
                    console.warn('Speech recognition not supported in this browser.');
                    this.micButton.disabled = true;
                    this.micButton.title = 'Voice input not supported in this browser';
                    this.micButton.classList.add('opacity-50', 'cursor-not-allowed');
                }
            }

            attachEventListeners() {
                this.chatForm.addEventListener('submit', (e) => this.handleSubmit(e));
                this.fileButton.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                this.micButton.addEventListener('click', () => this.toggleRecording());
                this.textInput.addEventListener('input', () => this.updateButtonStates());
                this.qrButton.addEventListener('click', () => this.scanQRCode());
                this.speechToggleButton.addEventListener('click', () => this.toggleSpeech());
                
                this.textInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.handleSubmit(e);
                    }
                });
                
                this.textInput.addEventListener('focus', () => {
                    window.speechSynthesis.cancel();
                });

                this.newChatButton.addEventListener('click', () => {
                    window.location.href = '/chat/';
                });

                this.chatItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-chat-button')) {
                            this.currentSessionId = item.dataset.sessionId;
                            window.location.href = `/chat/?session_id=${this.currentSessionId}`;
                        }
                    });
                });

                this.deleteButtons.forEach(button => {
                    button.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const sessionId = button.dataset.sessionId;
                        this.handleDeleteSession(sessionId);
                    });
                });
            }

            toggleSpeech() {
                this.speechEnabled = !this.speechEnabled;
                this.speechToggleButton.classList.toggle('text-parihar-500', this.speechEnabled);
                this.speechToggleButton.classList.toggle('bg-parihar-50', this.speechEnabled);
                this.speechToggleButton.classList.toggle('dark:bg-parihar-900/20', this.speechEnabled);
                this.speechToggleButton.title = this.speechEnabled ? 'Disable voice output' : 'Enable voice output';
                this.speechToggleButton.innerHTML = `<i class="fas fa-volume-${this.speechEnabled ? 'up' : 'mute'}"></i>`;
                if (!this.speechEnabled) {
                    window.speechSynthesis.cancel();
                }
            }

            toggleRecording() {
                if (!this.recognition) {
                    alert('Voice input is not supported in this browser.');
                    return;
                }
                
                if (this.isRecording) {
                    this.recognition.stop();
                } else {
                    if (this.isSending) return;
                    this.isRecording = true;
                    this.micButton.classList.remove('text-gray-400', 'hover:text-parihar-500', 'hover:bg-parihar-50', 'dark:hover:bg-parihar-900/20');
                    this.micButton.classList.add('text-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                    this.textInput.value = '';
                    this.updateButtonStates();
                    try {
                        this.recognition.start();
                    } catch (error) {
                        console.error('Error starting speech recognition:', error);
                        this.isRecording = false;
                        this.micButton.classList.remove('text-red-500', 'bg-red-50', 'dark:bg-red-900/20');
                        this.micButton.classList.add('text-gray-400', 'hover:text-parihar-500', 'hover:bg-parihar-50', 'dark:hover:bg-parihar-900/20');
                        this.updateButtonStates();
                        alert(`Failed to start voice input: ${error.message}`);
                    }
                }
            }

            async scanQRCode() {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    this.qrVideo.srcObject = stream;
                    this.qrVideo.classList.remove('hidden');
                    this.qrVideo.classList.add('fixed', 'inset-0', 'w-full', 'h-full', 'object-cover', 'z-50');
                    
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');

                    const scanLoop = setInterval(async () => {
                        canvas.width = this.qrVideo.videoWidth;
                        canvas.height = this.qrVideo.videoHeight;
                        context.drawImage(this.qrVideo, 0, 0, canvas.width, canvas.height);
                        const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                        const code = jsQR(imageData.data, canvas.width, canvas.height);

                        if (code && code.data) {
                            clearInterval(scanLoop);
                            this.qrVideo.classList.add('hidden');
                            this.qrVideo.classList.remove('fixed', 'inset-0', 'w-full', 'h-full', 'object-cover', 'z-50');
                            this.qrVideo.srcObject.getTracks().forEach(track => track.stop());

                            const driveUrl = code.data;
                            const directUrl = this.convertDriveUrlToDirect(driveUrl);
                            if (directUrl) {
                                const fileBlob = await this.fetchPdfFromBackend(driveUrl);
                                if (fileBlob) {
                                    const base64 = await this.blobToBase64(fileBlob);
                                    await this.sendMessage(null, {
                                        data: base64,
                                        mimeType: 'application/pdf',
                                        name: 'Scanned_QR_Document.pdf'
                                    });
                                }
                            } else {
                                alert('❌ Invalid Google Drive QR Code.');
                            }
                        }
                    }, 500);
                } catch (error) {
                    console.error("Camera access error:", error);
                    alert("❌ Failed to access camera.");
                }
            }

            convertDriveUrlToDirect(url) {
                try {
                    const fileId = url.split("/d/")[1].split("/")[0];
                    return `https://drive.google.com/uc?export=download&id=${fileId}`;
                } catch (e) {
                    return null;
                }
            }

            async fetchPdfFromBackend(qrUrl) {
                try {
                    const response = await fetch('/api/download_from_qr/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ qr_url: qrUrl })
                    });

                    const result = await response.json();
                    if (result.success) {
                        await this.sendMessage(null, {
                            data: result.data,
                            mimeType: result.mime_type,
                            name: result.name
                        });
                    } else {
                        alert('❌ ' + result.error);
                    }
                } catch (err) {
                    alert("❌ Failed to download from backend.");
                    console.error(err);
                }
            }

            async blobToBase64(blob) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64 = reader.result.split(',')[1];
                        resolve(base64);
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(blob);
                });
            }
 
            async handleDeleteSession(sessionId) {
                if (!confirm('Are you sure you want to delete this chat session?')) return;
                try {
                    const response = await fetch(`/api/chat/delete/${sessionId}/`, {
                        method: 'DELETE',
                    });
                    const data = await response.json();
                    if (data.success) {
                        if (this.currentSessionId === sessionId) {
                            window.location.href = '/chat/';
                        } else {
                            const chatItem = document.querySelector(`.chat-item[data-session-id="${sessionId}"]`);
                            if (chatItem) {
                                chatItem.style.transform = 'translateX(-100%)';
                                chatItem.style.opacity = '0';
                                setTimeout(() => chatItem.remove(), 300);
                            }
                        }
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error deleting session:', error);
                    alert('Failed to delete chat session. Please try again.');
                }
            }

            async handleSubmit(e) {
                e.preventDefault();
                const inputText = this.textInput.value.trim();
                if (!inputText || this.isSending) return;
                await this.sendMessage(inputText);
            }

            async handleFileUpload(e) {
                const file = e.target.files[0];
                if (!file || this.isSending) return;
                const fileData = await this.fileToBase64(file);
                await this.sendMessage(null, {
                    data: fileData.data,
                    mimeType: file.type,
                    name: file.name
                });
                this.fileInput.value = '';
            }

            async sendMessage(text = null, file = null) {
                if (this.isSending) return;
                
                if (this.emptyState) {
                    this.emptyState.style.display = 'none';
                }
                
                this.isSending = true;
                this.updateButtonStates();

                // Show loading indicator
                const loadingIndicator = document.querySelector('.loading-indicator');
                if (loadingIndicator) {
                    loadingIndicator.classList.remove('hidden');
                    this.scrollToBottom();
                }

                try {
                    const formData = new FormData();
                    if (text) {
                        formData.append('message', text);
                    }
                    if (file) {
                        formData.append('file', JSON.stringify({
                            mimeType: file.mimeType,
                            data: file.data,
                            name: file.name
                        }));
                    }
                    if (this.currentSessionId) {
                        formData.append('session_id', this.currentSessionId);
                    }
                    
                    const response = await fetch('/api/chat/', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        // Speak the assistant's reply if speech is enabled
                        if (data.response && this.speechEnabled) {
                            speakText(data.response, this.speechEnabled);
                        }
                        window.location.href = this.currentSessionId ? `/chat/?session_id=${this.currentSessionId}` : `/chat/?session_id=${data.session_id}`;
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Failed to send message. Please try again.');
                } finally {
                    // Hide loading indicator
                    const loadingIndicator = document.querySelector('.loading-indicator');
                    if (loadingIndicator) {
                        loadingIndicator.classList.add('hidden');
                    }
                    
                    this.isSending = false;
                    this.textInput.value = '';
                    this.updateButtonStates();
                    this.scrollToBottom();
                    
                    // Re-attach delete button listeners for new elements
                    this.deleteButtons = document.querySelectorAll('.delete-chat-button');
                    this.deleteButtons.forEach(button => {
                        if (!button.hasListener) {
                            button.hasListener = true;
                            button.addEventListener('click', (e) => {
                                e.stopPropagation();
                                const sessionId = button.dataset.sessionId;
                                this.handleDeleteSession(sessionId);
                            });
                        }
                    });
                }
            }

            updateButtonStates() {
                const hasText = this.textInput.value.trim().length > 0;
                
                // Update button states
                this.fileButton.disabled = this.isSending || this.isRecording;
                this.micButton.disabled = this.isSending || !this.recognition;
                this.qrButton.disabled = this.isSending || this.isRecording;
                this.sendButton.disabled = this.isSending || !hasText || this.isRecording;
                this.textInput.disabled = this.isSending || this.isRecording;
                
                // Update visual states
                if (this.isSending) {
                    this.sendButton.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    this.sendButton.classList.remove('opacity-50', 'cursor-not-allowed');
                }
                
                // Update input placeholder
                if (this.isRecording) {
                    this.textInput.placeholder = 'Listening...';
                } else if (this.isSending) {
                    this.textInput.placeholder = 'Sending...';
                } else {
                    this.textInput.placeholder = 'Message MaintenanceMate AI...';
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }

            async fileToBase64(file) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const base64Data = e.target.result.split(',')[1];
                        resolve({
                            data: base64Data,
                            mimeType: file.type,
                            name: file.name
                        });
                    };
                    reader.readAsDataURL(file);
                });
            }
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            new ChatApp();
        });

        // Dark mode toggle (optional - you can add this button to the UI if needed)
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', document.documentElement.classList.contains('dark'));
        }

        // Load dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            document.documentElement.classList.add('dark');
        }
    </script>
</body>
</html>